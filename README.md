# pg-role [![Build Status](https://travis-ci.com/vertebrae-org/pg-role.svg?token=vynfHvA2YnpLf76CJhW7&branch=master)](https://travis-ci.com/vertebrae-org/pg-role)

opinionated pg abstraction

### Opinionated?

This package requires you to create models with these columns:

-   id          SERIAL
-   created_at  TIMESTAMP
-   created_by  INT
-   updated_at  TIMESTAMP
-   updated_by  INT
-   deleted_at  TIMESTAMP
-   deleted_by  INT

Methods select, insert, update, remove, and restore use these columns to keep track of recent changes. Instead of deleting rows, the remove function will set a deleted_at timestamp.  This gives the ability to restore 'deleted' data by using the restore method, or simply nulling the deleted_at timestamp. You can later archive or delete rows where deleted_at is not null in a cron job.

By default, the select function will filter out any rows with a deleted_at timestamp. If you do want to see deleted rows add 'deleted: true' to the select options object.

created_by, updated_by, and deleted_by are optional, and are only added if 'userId' is present within a methods options parameter. 

### Usage

Of the various methods included in this libary, often times you will only need the '[Module](#modelinstance)' class, as it is an abstraction of all the other methods.  You may not need multiple connection pools ether, in this case the default connection values are used.
Use cases for calling select, insert, update, remove, restore directly include functions that dynamically set the model and pool when invoked.

### Roles

Another opinionated feature of this package is role pools configured by enviornment variables.  The module uses dotenv to populate env settings when you include a .env file in your project root folder.  The default pool uses env vars:

-   'PGHOST',
-   'PGPORT',
-   'PGDATABASE',
-   'PGUSER',
-   'PGPASSWORD'

Specifying one or more pool names within the db.conect method will connect multiple pools.  The connection will expect env vars:

-   'PG\_${pool}\_HOST',
-   'PG\_${pool}\_PORT',
-   'PG\_${pool}\_DATABASE',
-   'PG\_${pool}\_USER',
-   'PG\_${pool}\_PASSWORD'

### Async

This library is built with promises and expects you to await method results.  While it is a good idea to connect your pools when the app starts up, you don't have to.  If you call any method without specifying a pool connection to use, it will use the default pool.  If the default or specified connection pool has not yet been connected, it will wait until it connects, then call the method.  Pools are cached in the db.pools object.

### Model

You can use the Model class to abstract all CRUD methods into a model instance.  This can simplify reasoning about your database operations.

## Contributing

-   To run the dev environment, execute 'docker-compose up -d' or 'docker.compose up -d' from project directory, depending on how you've installed docker-compose.  This starts up a postgres instance on localhost:5432 and an 'adminer' process running on localhost:8000.  You can use adminer as a web based database administration tool while developing.
-   Any proposed new feature will need to have a test accomnpanying the pull request.  All test must pass travis before accepted and merged.

```javascript
async function example () {
    const Employee = new Model('employees');
    const employee = await Employee.create({
        email: 'employee@comany.com'
    });
    await employee.update({
        set: {
            email: 'manager@company.com'
        }
    });
    await employee.delete();
    await employee.restore();
});
```

## Methods

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

-   [Query](#query)
    -   [Parameters](#parameters)
    -   [Examples](#examples)
-   [Select](#select)
    -   [Parameters](#parameters-1)
    -   [Examples](#examples-1)
-   [Insert](#insert)
    -   [Parameters](#parameters-2)
    -   [Examples](#examples-2)
-   [Update](#update)
    -   [Parameters](#parameters-3)
    -   [Examples](#examples-3)
-   [Remove](#remove)
    -   [Parameters](#parameters-4)
    -   [Examples](#examples-4)
-   [Restore](#restore)
    -   [Parameters](#parameters-5)
    -   [Examples](#examples-5)
-   [Model](#model)
    -   [Parameters](#parameters-6)
    -   [create](#create)
        -   [Parameters](#parameters-7)
        -   [Examples](#examples-6)
    -   [select](#select-1)
        -   [Parameters](#parameters-8)
        -   [Examples](#examples-7)
    -   [find](#find)
        -   [Parameters](#parameters-9)
        -   [Examples](#examples-8)
-   [ModelInstance](#modelinstance)
    -   [Parameters](#parameters-10)
    -   [Examples](#examples-9)
    -   [get](#get)
        -   [Parameters](#parameters-11)
        -   [Examples](#examples-10)
    -   [update](#update-1)
        -   [Parameters](#parameters-12)
        -   [Examples](#examples-11)
    -   [delete](#delete)
        -   [Examples](#examples-12)
    -   [restore](#restore-1)
        -   [Examples](#examples-13)

### Query

```javascript
const {query} = require('pg-role');
```

#### Parameters

-   `options` **([object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object) \| [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String))** 
    -   `options.pool` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** pool connection name (optional, default `'default'`)
    -   `options.text` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** sql string

#### Examples

```javascript
async function getEmployeesByDomain (domain) {
     return await query(`
         select * from employees
         where email like '%@${domain}'
         limit 1000;
     `);
 }
```

```javascript
async function getEmployeesByDomain (domain) {
     return await query({
         pool: 'admin',
         text: `
             select * from employees
             where email like '%@${domain}'
             limit 1000;
         `
     });
 }
```

### Select

```javascript
const {select} = require('pg-role');
```

#### Parameters

-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `options.pool` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** pool connection name (optional, default `'default'`)
    -   `options.schema` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** database schema (optional, default `'public'`)
    -   `options.model` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** table to select from
    -   `options.where` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** conditions
    -   `options.id` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** add id to where conditions
    -   `options.group` **([array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array) \| [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String))** group by column(s) (optional, default `''`)
    -   `options.offset` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** offset result index (optional, default `0`)
    -   `options.limit` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** limit result length (optional, default `1000`)
    -   `options.deleted` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** do not filter rows with 'deleted_at' timestamp (optional, default `false`)

#### Examples

```javascript
async function getEmployee (id) {
     return await select({
         model: 'employees',
         id
     });
 }
```

```javascript
async function getDeletedEmployee (id) {
     return await select({
         model: 'employees',
         id,
         where: {
             deleted_at: 'not null'
         }
     });
 }
```

```javascript
async function getActiveEmployeesByRole (role) {
     return await select({
         model: 'employees',
         where: {
             role
         }
     });
 }
```

```javascript
async function getAllEmployeesByRole (role) {
     return await select({
         model: 'employees',
         deleted: true,
         where: {
             role
         }
     });
 }
```

### Insert

```javascript
const {insert} = require('pg-role');
```

#### Parameters

-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `options.pool` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** pool connection name (optional, default `'default'`)
    -   `options.schema` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** database schema (optional, default `'public'`)
    -   `options.model` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** table to select from
    -   `options.set` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** values to set

#### Examples

```javascript
async function newEmployee (set) {
     return await insert({
         model: 'employees',
         set
     });
 }
```

### Update

```javascript
const {update} = require('pg-role');
```

#### Parameters

-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `options.pool` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** pool connection name (optional, default `'default'`)
    -   `options.schema` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** database schema (optional, default `'public'`)
    -   `options.model` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** table to select from
    -   `options.where` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** conditions
    -   `options.id` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** add id to where conditions
    -   `options.set` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** values to set

#### Examples

```javascript
async function updateEmployee (id, set) {
     return await update({
         model: 'employees',
         id,
         set
     });
 }
```

### Remove

```javascript
const {remove} = require('pg-role');
```

#### Parameters

-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `options.pool` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** pool connection name (optional, default `'default'`)
    -   `options.schema` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** database schema (optional, default `'public'`)
    -   `options.model` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** table to select from
    -   `options.where` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** conditions
    -   `options.id` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** add id to where conditions

#### Examples

```javascript
async function removeEmployee (id) {
     return await remove({
         model: 'employees',
         id
     });
 }
```

### Restore

```javascript
const {restore} = require('pg-role');
```

#### Parameters

-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `options.pool` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** pool connection name (optional, default `'default'`)
    -   `options.schema` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** database schema (optional, default `'public'`)
    -   `options.model` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** table to select from
    -   `options.where` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** conditions
    -   `options.id` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** add id to where conditions

#### Examples

```javascript
async function restoreEmployee (id) {
     return await restore({
         model: 'employees',
         id
     });
 }
```

### Model

```javascript
const {Model} = require('pg-role');
```

#### Parameters

-   `model` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** Model name
-   `props` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** configuration object

#### create

##### Parameters

-   `set` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** set values object

##### Examples

```javascript
async function createEmployee (email) {
     const employee = await Employee.create({
         email
     });
     console.log(employee.get()));
 }
```

Returns **[ModelInstance](#modelinstance)** 

#### select

##### Parameters

-   `opts` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** options object

##### Examples

```javascript
async function findEmployees() {
     const employee = await Employee.select({
         where: {
             $like: {
                 email: '%@comapany.com'
             }
         }
     });
 }
```

Returns **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** selectObject

#### find

##### Parameters

-   `where` **([object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object) \| [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number))** id or where object
-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** options object

##### Examples

```javascript
async function createEmployee (email) {
     const Employee = new Model('employees');
     const employee = await Employee.find({
         email: testUserB
     });
     console.log(employee.get()));
 }
```

Returns **[ModelInstance](#modelinstance)** 

### ModelInstance

model instance created by Model.create('model_name')

#### Parameters

-   `model` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
-   `props` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
-   `data`  

#### Examples

```javascript
async function messWithEmployee (email) {
     const Employee = new Model('employee');
     const instance = await Employee.create({
         email: 'some.employee@company.com',
         position: 'employee'
     });
     console.log(instance.get()); // {id: 45, email: 'employee@company.com', ...}
     await instance.update({
         position: 'manager'
     });
     console.log(instance.get()); // {id: 45, email: 'manager@company.com, ...}
     await instance.delete();
     console.log(instance.get()); // {id: 45, email: 'manager@company.com, deleted_at: '2018-09-11T04:44:36.725Z', ...}
     await instance.restore();
     console.log(instance.get()); // {id: 45, email: 'manager@company.com, ...}
 }
```

#### get

##### Parameters

-   `prop` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** property to retrieve, if not specified all props are returned.

##### Examples

```javascript
async function testGet() {
     const Employee = new Model('employee');
     const employee = await Employee.create({
         email: 'employee@company.com'
     });
     console.log(employee.get()); // employee@company.com
     employee.update({
         email: 'manager@company.com'
     });
     console.log(employee.get()); // manager@company.com
 }
```

#### update

##### Parameters

-   `set`  
-   `props` **[set](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Set)** set values object

##### Examples

```javascript
async function updateEmployee(id, set) {
     const Employee = new Model('employee');
     const employee = await Employee.find(id);
     employee.update(set);
 }
```

#### delete

##### Examples

```javascript
async function deleteEmployee(id) {
     const Employee = new Model('employee');
     const employee = await Employee.find(id);
     employee.delete();
 }
```

#### restore

##### Examples

```javascript
async function deleteEmployee(id) {
     const Employee = new Model('employee');
     const employee = await Employee.find(id);
     employee.restore();
 }
```

## db

```javascript
const {db} = require('pg-role');
```

### connect

creates pool connection if not exists and waits for all to connect

#### Parameters

-   `roles` **([array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array) \| [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String))** 

### client

Creates a new pool connection if pool doesn't alread exist.
Returns that pool after connecting.

#### Parameters

-   `role` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 

### release

Release pool if available.
If no role is specified it will release all pools.

#### Parameters

-   `role` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
