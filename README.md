# pg-role [![Build Status](https://travis-ci.com/vertebrae-org/pg-role.svg?token=vynfHvA2YnpLf76CJhW7&branch=master)](https://travis-ci.com/vertebrae-org/pg-role)

opinionated pg abstraction focused on role based connection pools

### Opinionated?

While this library is not concerened with models or object mapping, it does require you to create models with these columns:

-   id
-   created_at
-   created_by
-   updated_at
-   updated_by
-   deleted_at
-   deleted_by

Methods select, insert, update, remove, and restore use these columns to keep track of recent changes. Instead of deleting rows, the remove function will set a deleted_at timestamp.  This gives the ability to restore 'deleted' data by using the restore method, or simply nulling the deleted_at timestamp. You can later archive or delete rows where deleted_at is not null in a cron job.

By default, the select function will filter out any rows with a deleted_at timestamp. If you do want to see deleted rows add {'deleted: true'} to the select options object.

## install

    npm install --save pg-role

## documentation

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

-   [select](#select)
    -   [Parameters](#parameters)
    -   [Examples](#examples)
-   [insert](#insert)
    -   [Parameters](#parameters-1)
    -   [Examples](#examples-1)
-   [update](#update)
    -   [Parameters](#parameters-2)
    -   [Examples](#examples-2)
-   [remove](#remove)
    -   [Parameters](#parameters-3)
    -   [Examples](#examples-3)
-   [restore](#restore)
    -   [Parameters](#parameters-4)
    -   [Examples](#examples-4)
-   [query](#query)
    -   [Parameters](#parameters-5)
    -   [Examples](#examples-5)
-   [def](#def)
    -   [Parameters](#parameters-6)
    -   [Examples](#examples-6)

### select

```javascript
const {select} = require('pg-role');
```

#### Parameters

-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `options.pool` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** pool connection name (optional, default `'default'`)
    -   `options.schema` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** database schema (optional, default `'public'`)
    -   `options.model` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** table to select from
    -   `options.where` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** conditions
    -   `options.id` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** add id to where conditions
    -   `options.group` **([array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array) \| [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String))** group by column(s) (optional, default `''`)
    -   `options.offset` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** offset result index (optional, default `0`)
    -   `options.limit` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** limit result length (optional, default `1000`)
    -   `options.deleted` **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** do not filter rows with 'deleted_at' timestamp (optional, default `false`)

#### Examples

```javascript
async function getEmployee (id) {
     return await select({
         model: 'employees',
         id
     });
 }
```

```javascript
async function getDeletedEmployee (id) {
     return await select({
         model: 'employees',
         id,
         deleted: true,
         where: {
             deleted_at: 'not null'
         }
     });
 }
```

```javascript
async function getEmployeesByRole (role) {
     return await select({
         model: 'employees',
         where: {
             role
         }
     });
 }
```

### insert

```javascript
const {insert} = require('pg-role');
```

#### Parameters

-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `options.pool` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** pool connection name (optional, default `'default'`)
    -   `options.schema` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** database schema (optional, default `'public'`)
    -   `options.model` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** table to select from
    -   `options.set` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** values to set

#### Examples

```javascript
async function newEmployee (set) {
     return await insert({
         model: 'employees',
         set
     });
 }
```

### update

```javascript
const {update} = require('pg-role');
```

#### Parameters

-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `options.pool` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** pool connection name (optional, default `'default'`)
    -   `options.schema` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** database schema (optional, default `'public'`)
    -   `options.model` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** table to select from
    -   `options.where` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** conditions
    -   `options.id` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** add id to where conditions
    -   `options.set` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** values to set

#### Examples

```javascript
async function updateEmployee (id, set) {
     return await update({
         model: 'employees',
         id,
         set
     });
 }
```

### remove

```javascript
const {remove} = require('pg-role');
```

#### Parameters

-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)**  (optional, default `{}`)
    -   `options.pool` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** pool connection name (optional, default `'default'`)
    -   `options.schema` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** database schema (optional, default `'public'`)
    -   `options.model` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** table to select from
    -   `options.where` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** conditions
    -   `options.id` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** add id to where conditions

#### Examples

```javascript
async function removeEmployee (id) {
     return await remove({
         model: 'employees',
         id
     });
 }
```

### restore

```javascript
const {restore} = require('pg-role');
```

#### Parameters

-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)**  (optional, default `{}`)
    -   `options.pool` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** pool connection name (optional, default `'default'`)
    -   `options.schema` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** database schema (optional, default `'public'`)
    -   `options.model` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** table to select from
    -   `options.where` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** conditions
    -   `options.id` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** add id to where conditions

#### Examples

```javascript
async function restoreEmployee (id) {
     return await restore({
         model: 'employees',
         id
     });
 }
```

### query

```javascript
const {query} = require('pg-role');
```

#### Parameters

-   `options` **([object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object) \| [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String))** 
    -   `options.pool` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** pool connection name (optional, default `'default'`)
    -   `options.text` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** sql string

#### Examples

```javascript
async function getEmployeesByDomain (domain) {
     return await query(`
         select * from employees
         where email like '%@${domain}'
         limit 1000;
     `);
 }
```

```javascript
async function getEmployeesByDomain (domain) {
     return await query({
         pool: 'admin',
         text: `
             select * from employees
             where email like '%@${domain}'
             limit 1000;
         `
     });
 }
```

### def

```javascript
const {def} = require('pg-role');
```

#### Parameters

-   `options` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `options.pool` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** pool connection name (optional, default `'default'`)
    -   `options.schema` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** database schema (optional, default `'public'`)
    -   `options.database` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** database name
    -   `options.model` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** table to select from

#### Examples

```javascript
async function getTableDef (database, model) {
     return await def({
         database,
         model
     });
 }
```

## db

```javascript
const {db} = require('pg-role');
```

### connect

creates pool connection if not exists and waits for all to connect

#### Parameters

-   `roles` **([array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array) \| [string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String))** 

### client

Creates a new pool connection if pool doesn't alread exist.
Returns that pool after connecting.

#### Parameters

-   `role` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 

### release

Release pool if available.
If no role is specified it will release all pools.

#### Parameters

-   `role` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
